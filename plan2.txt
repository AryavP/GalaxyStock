================================================================================
GALACTICSTOCKS - NATIVE ADMIN PANEL & PORTFOLIO SELL FEATURE
Technical Specification Document
================================================================================

Version: 2.0
Date: 2026-01-03
Status: Implementation Ready

================================================================================
TABLE OF CONTENTS
================================================================================

1. Executive Summary
2. Requirements & User Stories
3. System Architecture
4. Database Schema Changes
5. Backend API Specifications
6. Frontend Component Architecture
7. Authentication & Security
8. Migration Strategy
9. Testing Requirements
10. Implementation Timeline
11. Risk Assessment & Mitigation


================================================================================
1. EXECUTIVE SUMMARY
================================================================================

CONTEXT:
Currently, GalacticStocks relies on Google Sheets integration for game master
(GM) administration. This creates dependencies on external services and limits
the native capabilities of the web application. Additionally, players can only
buy stocks but cannot sell them, limiting gameplay flexibility.

OBJECTIVES:
1. Create a native admin panel within the web application for all GM functions
2. Remove dependency on Google Sheets for core administrative operations
3. Enable players to sell stocks from their portfolio
4. Add company descriptions to enhance player experience
5. Maintain backward compatibility during migration

SUCCESS CRITERIA:
- GM can perform all administrative tasks without leaving the web application
- Password-protected admin panel with ability to change password
- Players can sell stocks and receive real-time feedback
- Zero downtime migration from Google Sheets-based workflow
- All existing functionality preserved


================================================================================
2. REQUIREMENTS & USER STORIES
================================================================================

2.1 ADMIN PANEL - CORE REQUIREMENTS
------------------------------------

REQ-001: Admin Panel Access
PRIORITY: P0 (Critical)
As a Game Master, I want to access a secure admin panel from the web application
so that I can manage the stock market without using Google Sheets.

Acceptance Criteria:
- Admin panel accessible via dedicated route (/admin)
- Password protection with configurable password
- Initial default password: "admin"
- Password change functionality available within admin panel
- Session-based authentication (persists across page refreshes)
- Automatic logout on browser close or after 24 hours
- Clear visual distinction from player interface

REQ-002: Ticker Upload - Single Entry
PRIORITY: P0 (Critical)
As a Game Master, I want to create new tickers one at a time through a form
so that I can quickly add companies as needed during gameplay.

Acceptance Criteria:
- Form with fields: symbol, name, initial_price, trend, volatility, description
- Real-time validation (all fields required)
- Symbol must be unique (uppercase, alphanumeric, max 10 chars)
- Initial price must be positive number
- Trend: floating point number (can be negative, typically -0.1 to 0.1)
- Volatility: positive number (typically 0.1 to 0.5)
- Description: text field, max 500 characters
- Success/error feedback after submission
- Newly created ticker immediately available in market

REQ-003: Ticker Upload - Bulk CSV Import
PRIORITY: P0 (Critical)
As a Game Master, I want to upload multiple tickers via CSV so that I can
efficiently add many companies at once.

Acceptance Criteria:
- CSV upload interface with drag-and-drop support
- CSV format validation before processing
- Required columns: symbol, name, initial_price, trend, volatility, description
- Upsert logic: if symbol exists, update trend/volatility/description only
- Preview uploaded data before confirming
- Show validation errors with line numbers
- Batch processing with progress indicator
- Summary report: created, updated, failed entries
- Example CSV template downloadable from interface

CSV Format:
```
symbol,name,initial_price,trend,volatility,description
AEON,Aeon Industries,100.00,0.05,0.2,"Leading manufacturer of energy shields"
VOID,Void Transport,50.00,-0.02,0.3,"Interstellar shipping and logistics"
STAR,StarForge Corp,150.00,0.08,0.15,"Weapons manufacturing conglomerate"
```

REQ-004: Ticker Management - Update Parameters
PRIORITY: P0 (Critical)
As a Game Master, I want to update trend and volatility for existing tickers
so that I can adjust market dynamics during gameplay.

Acceptance Criteria:
- Searchable table of all existing tickers
- Inline editing for trend, volatility, and description
- Cannot modify symbol, name, or initial_price after creation
- Real-time validation on edit
- Save immediately or batch edit mode
- Show last modified timestamp for each ticker
- Audit log of parameter changes

REQ-005: Timestep Generation
PRIORITY: P0 (Critical)
As a Game Master, I want to generate new market timesteps so that stock prices
evolve according to simulation parameters.

Acceptance Criteria:
- "Generate Timestep" button prominently displayed
- Confirmation modal before generation
- Modal shows preview of calculated prices for all stocks
- Ability to override individual stock prices before confirming
- Override interface: select stock, enter custom price
- Visual indicator for overridden prices
- Generation locks market (prevents concurrent generation)
- WebSocket broadcast to all connected clients on completion
- Error handling if generation fails mid-process
- Cannot generate if already in progress

REQ-006: Price Override During Timestep
PRIORITY: P1 (High)
As a Game Master, I want to override specific stock prices during timestep
generation so that I can create narrative events or market interventions.

Acceptance Criteria:
- Price override modal appears after clicking "Generate Timestep"
- Table showing: symbol, company name, calculated price
- Editable price field for each stock
- Visual highlight for modified prices
- Percentage change indicator (vs current price)
- "Reset" button to revert to calculated price
- Validation: prices must be positive
- Override flag stored in database for transparency
- Overridden prices marked in price history

REQ-007: Player P&L Dashboard
PRIORITY: P1 (High)
As a Game Master, I want to view all players' profit/loss data so that I can
monitor gameplay balance and competitiveness.

Acceptance Criteria:
- Dashboard showing all characters with holdings
- Columns: character name, total value, cost basis, P/L amount, P/L %
- Sortable by any column
- Color coding: green (profit), red (loss), gray (neutral)
- Drill-down to see individual holdings per character
- Export to CSV functionality
- Real-time updates when market changes
- Option to view P/L at specific timestep (historical view)

REQ-008: Admin Authentication Management
PRIORITY: P1 (High)
As a Game Master, I want to change the admin password so that players cannot
access sensitive game metadata.

Acceptance Criteria:
- Password change form in admin settings
- Required fields: current password, new password, confirm password
- Password strength indicator
- Minimum 8 characters required
- Passwords stored securely (hashed with bcrypt/argon2)
- Session invalidation on password change
- Success confirmation message
- Cannot use last 3 passwords (password history)


2.2 PLAYER FEATURES - STOCK SELLING
------------------------------------

REQ-009: Sell Stock from Portfolio
PRIORITY: P0 (Critical)
As a Player, I want to sell stocks from my portfolio so that I can realize
profits or cut losses.

Acceptance Criteria:
- "Sell" button next to each holding in portfolio
- Sell modal similar to buy modal
- Shows: current holdings, current price, estimated proceeds
- Quantity selector with max = current holdings
- Input validation: cannot sell more than owned
- Real-time calculation of total proceeds
- Display realized P/L for the sale
- Confirmation dialog before executing
- Success modal showing: quantity sold, price, total proceeds, realized P/L
- Portfolio updates immediately after sale
- Transaction recorded in database
- WebSocket notification to admin dashboard (optional)

REQ-010: Company Descriptions
PRIORITY: P1 (High)
As a Player, I want to see company descriptions when I hover over stocks
so that I can make informed investment decisions.

Acceptance Criteria:
- Tooltip appears on hover (market view and portfolio view)
- Tooltip shows: company name, symbol, current price, description
- Graceful handling of missing descriptions (show "No description available")
- Tooltip positioned intelligently (avoid screen edge cutoff)
- Smooth fade-in/fade-out animation
- Touch-friendly on mobile (tap to show, tap outside to hide)
- Tooltip remains visible while mouse is over it
- Close button for mobile users


2.3 NON-FUNCTIONAL REQUIREMENTS
--------------------------------

REQ-011: Performance
- Admin panel loads in < 2 seconds
- CSV upload processes 1000 rows in < 5 seconds
- Timestep generation completes in < 3 seconds for 50 stocks
- Sell transaction completes in < 500ms

REQ-012: Reliability
- 99.9% uptime for admin operations
- Zero data loss during CSV imports
- Atomic transactions for all database operations
- Automatic retry for failed WebSocket broadcasts

REQ-013: Usability
- Admin panel works on desktop browsers (Chrome, Firefox, Safari)
- Mobile-responsive for viewing (admin operations desktop-only)
- Keyboard shortcuts for common actions
- Undo capability for accidental ticker updates

REQ-014: Security
- Admin routes blocked for non-authenticated users
- Password hashing with industry-standard algorithm
- CSRF protection on admin forms
- Rate limiting on admin login attempts
- SQL injection prevention (parameterized queries)
- XSS protection on all inputs


================================================================================
3. SYSTEM ARCHITECTURE
================================================================================

3.1 ARCHITECTURE OVERVIEW
--------------------------

┌─────────────────────────────────────────────────────────────────────┐
│                          FRONTEND (React)                           │
├─────────────────────────────────────────────────────────────────────┤
│  Player Routes          │  Admin Routes (Protected)                 │
│  - Login                │  - Admin Login                            │
│  - Portfolio (enhanced) │  - Ticker Management                      │
│  - Market (enhanced)    │  - Timestep Generator                     │
│                         │  - Player P&L Dashboard                   │
│                         │  - Settings (password change)             │
├─────────────────────────────────────────────────────────────────────┤
│  Shared Components                                                  │
│  - BuyModal             │  - StockChart                             │
│  - SellModal (NEW)      │  - Tooltip (NEW)                          │
│  - Header               │  - AdminLayout (NEW)                      │
├─────────────────────────────────────────────────────────────────────┤
│  State Management                                                   │
│  - AppContext (existing)│  - AdminContext (NEW)                     │
│  - WebSocket Manager    │                                           │
└─────────────────────────────────────────────────────────────────────┘
                                    ↕ HTTP/WS
┌─────────────────────────────────────────────────────────────────────┐
│                      BACKEND (FastAPI)                              │
├─────────────────────────────────────────────────────────────────────┤
│  API Routes                                                         │
│  - /api/market          │  - /api/admin/login (NEW)                 │
│  - /api/portfolio       │  - /api/admin/tickers (NEW)               │
│  - /api/transaction/buy │  - /api/admin/timestep (enhanced)         │
│  - /api/transaction/sell│  - /api/admin/players (NEW)               │
│  - /ws (WebSocket)      │  - /api/admin/settings (NEW)              │
├─────────────────────────────────────────────────────────────────────┤
│  Business Logic                                                     │
│  - StockMarket          │  - AdminService (NEW)                     │
│  - Database Layer       │  - AuthService (NEW)                      │
│  - WebSocket Manager    │  - CSVProcessor (NEW)                     │
└─────────────────────────────────────────────────────────────────────┘
                                    ↕
┌─────────────────────────────────────────────────────────────────────┐
│                    DATABASE (SQLite)                                │
├─────────────────────────────────────────────────────────────────────┤
│  Tables                                                             │
│  - stock_prices         │  - companies (NEW)                        │
│  - portfolios           │  - admin_config (NEW)                     │
│  - transactions         │  - admin_sessions (NEW)                   │
│  - market_state         │  - audit_log (NEW)                        │
└─────────────────────────────────────────────────────────────────────┘


3.2 DATA FLOW - SELL STOCK
---------------------------

1. User clicks "Sell" on portfolio holding
2. SellModal renders with current holding data
3. User enters quantity and confirms
4. Frontend validation (quantity <= holdings)
5. POST /api/transaction/sell with { character_name, symbol, quantity }
6. Backend validates holdings and current price
7. Database transaction:
   - Insert into transactions table
   - Update portfolios table (reduce quantity or delete if 0)
8. Return TransactionResponse with proceeds and realized P/L
9. Frontend updates portfolio state
10. Success modal displays transaction details


3.3 DATA FLOW - TIMESTEP GENERATION (ADMIN)
--------------------------------------------

1. Admin clicks "Generate Timestep" button
2. Frontend fetches preview prices: GET /api/admin/timestep/preview
3. Modal displays calculated prices
4. Admin can override individual prices
5. Admin confirms generation
6. POST /api/admin/timestep with { overrides: {symbol: price} }
7. Backend:
   - Acquires generation lock
   - Calculates new prices using StockMarket.generate_timestep()
   - Applies any overrides
   - Saves prices to database with override flags
   - Updates market_state
   - Releases lock
   - Broadcasts WebSocket event
8. All connected clients receive updated prices
9. Frontend refreshes market and portfolio views


================================================================================
4. DATABASE SCHEMA CHANGES
================================================================================

4.1 NEW TABLE: companies
------------------------
Stores all company metadata (replaces Google Sheets as source of truth)

```sql
CREATE TABLE companies (
    symbol TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    initial_price REAL NOT NULL,
    trend REAL NOT NULL,
    volatility REAL NOT NULL,
    description TEXT DEFAULT '',
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    created_by TEXT DEFAULT 'system',
    CONSTRAINT symbol_format CHECK (symbol = upper(symbol)),
    CONSTRAINT positive_price CHECK (initial_price > 0),
    CONSTRAINT positive_volatility CHECK (volatility >= 0)
);

CREATE INDEX idx_companies_symbol ON companies(symbol);
```

Fields:
- symbol: Unique ticker symbol (e.g., "AEON", "VOID")
- name: Company full name (e.g., "Aeon Industries")
- initial_price: Starting price at timestep 0
- trend: Drift parameter for price simulation (e.g., 0.05 = 5% upward trend)
- volatility: Standard deviation for random walk (e.g., 0.2)
- description: Player-visible description (max 500 chars)
- created_at: ISO timestamp of creation
- updated_at: ISO timestamp of last modification
- created_by: Admin username or 'system'


4.2 NEW TABLE: admin_config
----------------------------
Stores admin panel configuration and credentials

```sql
CREATE TABLE admin_config (
    id INTEGER PRIMARY KEY CHECK (id = 1),
    password_hash TEXT NOT NULL,
    password_salt TEXT NOT NULL,
    last_password_change TEXT NOT NULL,
    password_history TEXT DEFAULT '[]',  -- JSON array of last 3 hashes
    session_timeout_hours INTEGER DEFAULT 24,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

-- Initialize with default password "admin"
INSERT INTO admin_config (
    id, password_hash, password_salt, last_password_change, created_at, updated_at
) VALUES (
    1,
    '<BCRYPT_HASH_OF_admin>',
    '<RANDOM_SALT>',
    datetime('now'),
    datetime('now'),
    datetime('now')
);
```

Fields:
- id: Always 1 (singleton pattern)
- password_hash: Bcrypt hash of admin password
- password_salt: Random salt for hashing
- last_password_change: ISO timestamp of last password change
- password_history: JSON array of last 3 password hashes (prevent reuse)
- session_timeout_hours: How long sessions remain valid
- created_at/updated_at: Audit timestamps


4.3 NEW TABLE: admin_sessions
------------------------------
Manages admin authentication sessions

```sql
CREATE TABLE admin_sessions (
    session_token TEXT PRIMARY KEY,
    created_at TEXT NOT NULL,
    expires_at TEXT NOT NULL,
    last_activity TEXT NOT NULL,
    ip_address TEXT,
    user_agent TEXT
);

CREATE INDEX idx_sessions_expires ON admin_sessions(expires_at);
CREATE INDEX idx_sessions_token ON admin_sessions(session_token);

-- Auto-cleanup old sessions
CREATE TRIGGER cleanup_expired_sessions
AFTER INSERT ON admin_sessions
BEGIN
    DELETE FROM admin_sessions WHERE expires_at < datetime('now');
END;
```

Fields:
- session_token: UUID v4 token for authentication
- created_at: Session creation timestamp
- expires_at: Session expiration timestamp (created_at + timeout_hours)
- last_activity: Last request timestamp (for session refresh)
- ip_address: Client IP (for security auditing)
- user_agent: Client user agent (for security auditing)


4.4 NEW TABLE: audit_log
-------------------------
Records all admin actions for compliance and debugging

```sql
CREATE TABLE audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TEXT NOT NULL,
    action_type TEXT NOT NULL,
    entity_type TEXT,
    entity_id TEXT,
    old_values TEXT,  -- JSON
    new_values TEXT,  -- JSON
    session_token TEXT,
    ip_address TEXT,
    success INTEGER DEFAULT 1,
    error_message TEXT
);

CREATE INDEX idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX idx_audit_action ON audit_log(action_type);
CREATE INDEX idx_audit_entity ON audit_log(entity_type, entity_id);
```

Fields:
- id: Auto-increment primary key
- timestamp: ISO timestamp of action
- action_type: e.g., "CREATE_TICKER", "UPDATE_TREND", "GENERATE_TIMESTEP"
- entity_type: e.g., "company", "market_state", "admin_config"
- entity_id: e.g., symbol "AEON"
- old_values: JSON snapshot before change
- new_values: JSON snapshot after change
- session_token: Which session performed action
- ip_address: Client IP
- success: 1 if succeeded, 0 if failed
- error_message: Error details if failed


4.5 MODIFICATIONS TO EXISTING TABLES
-------------------------------------

MODIFY: stock_prices (add company reference)
```sql
-- Add foreign key to companies table
-- Note: SQLite doesn't support ALTER TABLE ADD CONSTRAINT,
-- so this requires table recreation during migration

CREATE TABLE stock_prices_new (
    symbol TEXT NOT NULL,
    timestep INTEGER NOT NULL,
    price REAL NOT NULL,
    timestamp TEXT NOT NULL,
    is_override INTEGER DEFAULT 0,
    PRIMARY KEY (symbol, timestep),
    FOREIGN KEY (symbol) REFERENCES companies(symbol) ON DELETE CASCADE
);

INSERT INTO stock_prices_new SELECT * FROM stock_prices;
DROP TABLE stock_prices;
ALTER TABLE stock_prices_new RENAME TO stock_prices;

CREATE INDEX idx_stock_prices_symbol ON stock_prices(symbol, timestep DESC);
```

NO CHANGES REQUIRED:
- portfolios: Already tracks holdings correctly
- transactions: Already records buy/sell transactions
- market_state: Already tracks timestep and generation lock


4.6 MIGRATION SCRIPT
---------------------

```sql
-- migration_v2.sql

BEGIN TRANSACTION;

-- 1. Create new tables
CREATE TABLE IF NOT EXISTS companies (
    symbol TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    initial_price REAL NOT NULL,
    trend REAL NOT NULL,
    volatility REAL NOT NULL,
    description TEXT DEFAULT '',
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    created_by TEXT DEFAULT 'system',
    CONSTRAINT symbol_format CHECK (symbol = upper(symbol)),
    CONSTRAINT positive_price CHECK (initial_price > 0),
    CONSTRAINT positive_volatility CHECK (volatility >= 0)
);

CREATE TABLE IF NOT EXISTS admin_config (
    id INTEGER PRIMARY KEY CHECK (id = 1),
    password_hash TEXT NOT NULL,
    password_salt TEXT NOT NULL,
    last_password_change TEXT NOT NULL,
    password_history TEXT DEFAULT '[]',
    session_timeout_hours INTEGER DEFAULT 24,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS admin_sessions (
    session_token TEXT PRIMARY KEY,
    created_at TEXT NOT NULL,
    expires_at TEXT NOT NULL,
    last_activity TEXT NOT NULL,
    ip_address TEXT,
    user_agent TEXT
);

CREATE TABLE IF NOT EXISTS audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TEXT NOT NULL,
    action_type TEXT NOT NULL,
    entity_type TEXT,
    entity_id TEXT,
    old_values TEXT,
    new_values TEXT,
    session_token TEXT,
    ip_address TEXT,
    success INTEGER DEFAULT 1,
    error_message TEXT
);

-- 2. Create indexes
CREATE INDEX IF NOT EXISTS idx_companies_symbol ON companies(symbol);
CREATE INDEX IF NOT EXISTS idx_sessions_expires ON admin_sessions(expires_at);
CREATE INDEX IF NOT EXISTS idx_sessions_token ON admin_sessions(session_token);
CREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_action ON audit_log(action_type);
CREATE INDEX IF NOT EXISTS idx_audit_entity ON audit_log(entity_type, entity_id);

-- 3. Initialize admin config with default password "admin"
-- Note: Hash generated with bcrypt, cost=12
INSERT OR IGNORE INTO admin_config (
    id,
    password_hash,
    password_salt,
    last_password_change,
    created_at,
    updated_at
) VALUES (
    1,
    '$2b$12$PLACEHOLDER_HASH',  -- Replace with actual hash
    'PLACEHOLDER_SALT',
    datetime('now'),
    datetime('now'),
    datetime('now')
);

-- 4. Migrate existing companies from Google Sheets or stock_prices
-- This will be done programmatically via Python script

COMMIT;
```


================================================================================
5. BACKEND API SPECIFICATIONS
================================================================================

5.1 ADMIN AUTHENTICATION ENDPOINTS
-----------------------------------

POST /api/admin/login
---------------------
Authenticate admin user and create session.

Request Body:
```json
{
  "password": "admin"
}
```

Response 200 OK:
```json
{
  "success": true,
  "session_token": "550e8400-e29b-41d4-a716-446655440000",
  "expires_at": "2026-01-04T14:30:00Z"
}
```

Response 401 Unauthorized:
```json
{
  "success": false,
  "error": "Invalid password"
}
```

Implementation Notes:
- Generate UUID v4 for session_token
- Set expires_at to current_time + session_timeout_hours
- Store session in admin_sessions table
- Return session_token as HTTP-only cookie AND in response body
- Rate limit: max 5 attempts per minute per IP
- Log failed attempts to audit_log


POST /api/admin/logout
----------------------
Invalidate current admin session.

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

Implementation Notes:
- Delete session from admin_sessions table
- Clear session cookie


POST /api/admin/verify
----------------------
Verify if current session is valid (for frontend session check).

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```json
{
  "valid": true,
  "expires_at": "2026-01-04T14:30:00Z"
}
```

Response 401 Unauthorized:
```json
{
  "valid": false,
  "error": "Session expired"
}
```


POST /api/admin/change-password
-------------------------------
Change admin password (requires current password).

Headers:
```
Authorization: Bearer <session_token>
```

Request Body:
```json
{
  "current_password": "admin",
  "new_password": "newSecurePassword123!",
  "confirm_password": "newSecurePassword123!"
}
```

Response 200 OK:
```json
{
  "success": true,
  "message": "Password changed successfully"
}
```

Response 400 Bad Request:
```json
{
  "success": false,
  "error": "New password does not meet requirements"
}
```

Response 401 Unauthorized:
```json
{
  "success": false,
  "error": "Current password is incorrect"
}
```

Response 409 Conflict:
```json
{
  "success": false,
  "error": "Cannot reuse previous passwords"
}
```

Implementation Notes:
- Validate current_password against stored hash
- Validate new_password strength (min 8 chars, mix of letters/numbers)
- Check new_password against password_history
- Hash new_password with bcrypt (cost=12)
- Update admin_config.password_hash
- Add old hash to password_history (keep last 3)
- Invalidate all existing sessions except current one
- Log to audit_log


5.2 TICKER MANAGEMENT ENDPOINTS
--------------------------------

GET /api/admin/tickers
----------------------
Retrieve all tickers with metadata.

Headers:
```
Authorization: Bearer <session_token>
```

Query Parameters:
- search: (optional) Filter by symbol or name
- sort_by: (optional) Field to sort by (symbol|name|updated_at)
- sort_order: (optional) asc|desc (default: asc)

Response 200 OK:
```json
{
  "tickers": [
    {
      "symbol": "AEON",
      "name": "Aeon Industries",
      "initial_price": 100.00,
      "trend": 0.05,
      "volatility": 0.2,
      "description": "Leading manufacturer of energy shields",
      "created_at": "2026-01-01T10:00:00Z",
      "updated_at": "2026-01-03T14:30:00Z",
      "created_by": "admin"
    },
    {
      "symbol": "VOID",
      "name": "Void Transport",
      "initial_price": 50.00,
      "trend": -0.02,
      "volatility": 0.3,
      "description": "Interstellar shipping and logistics",
      "created_at": "2026-01-01T10:00:00Z",
      "updated_at": "2026-01-01T10:00:00Z",
      "created_by": "system"
    }
  ],
  "count": 2
}
```


POST /api/admin/tickers
-----------------------
Create a new ticker.

Headers:
```
Authorization: Bearer <session_token>
```

Request Body:
```json
{
  "symbol": "AEON",
  "name": "Aeon Industries",
  "initial_price": 100.00,
  "trend": 0.05,
  "volatility": 0.2,
  "description": "Leading manufacturer of energy shields"
}
```

Response 201 Created:
```json
{
  "success": true,
  "ticker": {
    "symbol": "AEON",
    "name": "Aeon Industries",
    "initial_price": 100.00,
    "trend": 0.05,
    "volatility": 0.2,
    "description": "Leading manufacturer of energy shields",
    "created_at": "2026-01-03T14:30:00Z",
    "updated_at": "2026-01-03T14:30:00Z",
    "created_by": "admin"
  },
  "message": "Ticker created successfully"
}
```

Response 400 Bad Request:
```json
{
  "success": false,
  "error": "Symbol must be uppercase alphanumeric",
  "field": "symbol"
}
```

Response 409 Conflict:
```json
{
  "success": false,
  "error": "Ticker with symbol AEON already exists"
}
```

Implementation Notes:
- Validate all fields (see validation rules in requirements)
- Convert symbol to uppercase
- If market already has prices (timestep > 0), create initial price entry
- Log to audit_log with action_type="CREATE_TICKER"
- Broadcast WebSocket event to notify players of new ticker


PUT /api/admin/tickers/{symbol}
-------------------------------
Update ticker parameters (trend, volatility, description only).

Headers:
```
Authorization: Bearer <session_token>
```

Request Body:
```json
{
  "trend": 0.08,
  "volatility": 0.25,
  "description": "Updated description"
}
```

Response 200 OK:
```json
{
  "success": true,
  "ticker": {
    "symbol": "AEON",
    "name": "Aeon Industries",
    "initial_price": 100.00,
    "trend": 0.08,
    "volatility": 0.25,
    "description": "Updated description",
    "created_at": "2026-01-01T10:00:00Z",
    "updated_at": "2026-01-03T14:30:00Z",
    "created_by": "admin"
  },
  "message": "Ticker updated successfully"
}
```

Response 404 Not Found:
```json
{
  "success": false,
  "error": "Ticker INVALID not found"
}
```

Implementation Notes:
- Cannot update symbol, name, or initial_price
- Validate trend and volatility values
- Log to audit_log with old_values and new_values
- Update updated_at timestamp


DELETE /api/admin/tickers/{symbol}
----------------------------------
Delete a ticker (only if no transactions exist).

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```json
{
  "success": true,
  "message": "Ticker AEON deleted successfully"
}
```

Response 409 Conflict:
```json
{
  "success": false,
  "error": "Cannot delete ticker with existing transactions",
  "transaction_count": 42
}
```

Implementation Notes:
- Check if any transactions exist for this symbol
- If transactions exist, return 409 error
- Delete cascades to stock_prices (foreign key constraint)
- Log to audit_log


POST /api/admin/tickers/bulk-upload
------------------------------------
Upload multiple tickers via CSV.

Headers:
```
Authorization: Bearer <session_token>
Content-Type: multipart/form-data
```

Request Body (multipart):
- file: CSV file

Response 200 OK:
```json
{
  "success": true,
  "summary": {
    "total_rows": 10,
    "created": 7,
    "updated": 2,
    "failed": 1
  },
  "details": [
    {
      "row": 1,
      "symbol": "AEON",
      "action": "created",
      "status": "success"
    },
    {
      "row": 5,
      "symbol": "INVALID",
      "action": "create",
      "status": "failed",
      "error": "Invalid initial_price"
    }
  ]
}
```

Response 400 Bad Request:
```json
{
  "success": false,
  "error": "Invalid CSV format: missing required column 'trend'"
}
```

Implementation Notes:
- Validate CSV headers match required fields
- Process rows in transaction (all or nothing per row)
- Upsert logic: if symbol exists, update trend/volatility/description only
- Return detailed report of all operations
- Log each operation to audit_log


5.3 TIMESTEP MANAGEMENT ENDPOINTS
----------------------------------

GET /api/admin/timestep/preview
--------------------------------
Preview next timestep prices without committing.

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```json
{
  "current_timestep": 5,
  "next_timestep": 6,
  "prices": [
    {
      "symbol": "AEON",
      "name": "Aeon Industries",
      "current_price": 105.20,
      "calculated_price": 107.83,
      "change_percent": 2.50
    },
    {
      "symbol": "VOID",
      "name": "Void Transport",
      "current_price": 48.50,
      "calculated_price": 47.92,
      "change_percent": -1.20
    }
  ]
}
```

Implementation Notes:
- Run price simulation without saving to database
- Return calculated prices for all tickers
- Include percentage change for GM review


POST /api/admin/timestep
-------------------------
Generate new timestep with optional price overrides.

Headers:
```
Authorization: Bearer <session_token>
```

Request Body:
```json
{
  "overrides": {
    "AEON": 110.00,
    "VOID": 50.00
  }
}
```

Response 200 OK:
```json
{
  "success": true,
  "timestep": 6,
  "last_updated": "2026-01-03T14:30:00Z",
  "prices": {
    "AEON": 110.00,
    "VOID": 50.00,
    "STAR": 153.27
  },
  "overridden": ["AEON", "VOID"]
}
```

Response 409 Conflict:
```json
{
  "success": false,
  "error": "Timestep generation already in progress"
}
```

Implementation Notes:
- Acquire generation lock before starting
- Calculate new prices using StockMarket.generate_timestep()
- Apply any overrides from request
- Save prices with is_override flag for overridden prices
- Update market_state.current_timestep
- Release generation lock
- Broadcast WebSocket event to all clients
- Log to audit_log with action_type="GENERATE_TIMESTEP"
- Enhanced from existing /api/admin/timestep endpoint


5.4 PLAYER MONITORING ENDPOINTS
--------------------------------

GET /api/admin/players
----------------------
Get P&L data for all players.

Headers:
```
Authorization: Bearer <session_token>
```

Query Parameters:
- sort_by: (optional) total_value|profit_loss|profit_loss_percentage
- sort_order: (optional) asc|desc (default: desc)

Response 200 OK:
```json
{
  "players": [
    {
      "character_name": "Aria Stormwind",
      "total_value": 15420.50,
      "total_cost_basis": 12000.00,
      "total_profit_loss": 3420.50,
      "profit_loss_percentage": 28.50,
      "holding_count": 5,
      "last_transaction": "2026-01-03T12:15:00Z"
    },
    {
      "character_name": "Kael Ironforge",
      "total_value": 8750.00,
      "total_cost_basis": 9200.00,
      "total_profit_loss": -450.00,
      "profit_loss_percentage": -4.89,
      "holding_count": 3,
      "last_transaction": "2026-01-02T18:30:00Z"
    }
  ],
  "timestamp": "2026-01-03T14:30:00Z",
  "market_timestep": 6
}
```


GET /api/admin/players/{character_name}
---------------------------------------
Get detailed holdings and transaction history for a player.

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```json
{
  "character_name": "Aria Stormwind",
  "portfolio": {
    "holdings": [
      {
        "symbol": "AEON",
        "company_name": "Aeon Industries",
        "quantity": 50,
        "avg_purchase_price": 98.50,
        "current_price": 110.00,
        "current_value": 5500.00,
        "cost_basis": 4925.00,
        "profit_loss": 575.00,
        "profit_loss_percentage": 11.68
      }
    ],
    "total_value": 15420.50,
    "total_cost_basis": 12000.00,
    "total_profit_loss": 3420.50,
    "profit_loss_percentage": 28.50
  },
  "recent_transactions": [
    {
      "id": 123,
      "symbol": "AEON",
      "type": "BUY",
      "quantity": 50,
      "price": 98.50,
      "total_amount": 4925.00,
      "timestamp": "2026-01-02T10:00:00Z",
      "timestep": 4
    }
  ]
}
```


GET /api/admin/export/players
------------------------------
Export player P&L data as CSV.

Headers:
```
Authorization: Bearer <session_token>
```

Response 200 OK:
```
Content-Type: text/csv
Content-Disposition: attachment; filename="player_pnl_2026-01-03.csv"

character_name,total_value,total_cost_basis,profit_loss,profit_loss_percentage,holding_count
Aria Stormwind,15420.50,12000.00,3420.50,28.50,5
Kael Ironforge,8750.00,9200.00,-450.00,-4.89,3
```


5.5 ENHANCED TRANSACTION ENDPOINTS
-----------------------------------

POST /api/transaction/sell (ENHANCED)
--------------------------------------
Existing endpoint enhanced with improved response.

Request Body:
```json
{
  "character_name": "Aria Stormwind",
  "symbol": "AEON",
  "quantity": 10
}
```

Response 200 OK:
```json
{
  "success": true,
  "transaction_id": 124,
  "message": "Sold 10 shares of AEON for ¢1,100.00 (Realized P/L: ¢+115.00)",
  "details": {
    "symbol": "AEON",
    "quantity_sold": 10,
    "sale_price": 110.00,
    "total_proceeds": 1100.00,
    "avg_purchase_price": 98.50,
    "realized_profit_loss": 115.00,
    "realized_pl_percentage": 11.68,
    "remaining_quantity": 40
  },
  "new_holding": {
    "symbol": "AEON",
    "quantity": 40,
    "avg_purchase_price": 98.50
  }
}
```

Response 400 Bad Request:
```json
{
  "success": false,
  "error": "Insufficient shares. Have 40, trying to sell 50",
  "current_holdings": 40
}
```

Response 404 Not Found:
```json
{
  "success": false,
  "error": "No holdings found for AEON"
}
```


5.6 COMPANY DATA ENDPOINT (NEW)
--------------------------------

GET /api/companies
------------------
Get all companies with descriptions (public endpoint for players).

Response 200 OK:
```json
{
  "companies": [
    {
      "symbol": "AEON",
      "name": "Aeon Industries",
      "description": "Leading manufacturer of energy shields",
      "initial_price": 100.00
    },
    {
      "symbol": "VOID",
      "name": "Void Transport",
      "description": "Interstellar shipping and logistics",
      "initial_price": 50.00
    }
  ]
}
```

Implementation Notes:
- Public endpoint (no authentication required)
- Excludes admin-only fields (trend, volatility)
- Cached for 5 minutes to reduce database load


GET /api/companies/{symbol}
---------------------------
Get detailed information for a specific company.

Response 200 OK:
```json
{
  "symbol": "AEON",
  "name": "Aeon Industries",
  "description": "Leading manufacturer of energy shields",
  "initial_price": 100.00,
  "current_price": 110.00,
  "price_change_24h": 2.50,
  "all_time_high": 115.30,
  "all_time_low": 95.20
}
```


5.7 WEBSOCKET EVENTS (ENHANCED)
--------------------------------

Event: timestep_updated (ENHANCED)
-----------------------------------
Broadcast when new timestep is generated.

```json
{
  "type": "timestep_updated",
  "timestep": 6,
  "prices": {
    "AEON": 110.00,
    "VOID": 50.00,
    "STAR": 153.27
  },
  "timestamp": "2026-01-03T14:30:00Z",
  "overridden_symbols": ["AEON"]
}
```

Event: ticker_created (NEW)
----------------------------
Broadcast when admin creates a new ticker.

```json
{
  "type": "ticker_created",
  "ticker": {
    "symbol": "NOVA",
    "name": "Nova Dynamics",
    "description": "Quantum computing solutions",
    "initial_price": 200.00
  },
  "timestamp": "2026-01-03T14:30:00Z"
}
```

Event: ticker_updated (NEW)
----------------------------
Broadcast when admin updates ticker parameters.

```json
{
  "type": "ticker_updated",
  "symbol": "AEON",
  "changes": {
    "trend": 0.08,
    "volatility": 0.25,
    "description": "Updated description"
  },
  "timestamp": "2026-01-03T14:30:00Z"
}
```


================================================================================
6. FRONTEND COMPONENT ARCHITECTURE
================================================================================

6.1 NEW ADMIN COMPONENTS
-------------------------

Component: AdminLogin
Location: /src/pages/admin/AdminLogin.tsx

Purpose: Admin authentication page

Props: None

State:
- password: string
- error: string | null
- isLoading: boolean

Key Features:
- Password input with visibility toggle
- Enter key submits form
- Error display for failed attempts
- Loading state during authentication
- Redirect to /admin/dashboard on success

Implementation:
```typescript
interface AdminLoginProps {}

export const AdminLogin: React.FC<AdminLoginProps> = () => {
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const navigate = useNavigate();
  const { login } = useAdminAuth();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setIsLoading(true);

    try {
      const result = await login(password);
      if (result.success) {
        navigate('/admin/dashboard');
      } else {
        setError(result.error);
      }
    } catch (err) {
      setError('Login failed. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-space-dark to-space-blue">
      <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
        <h1 className="text-2xl font-bold mb-6 text-center">Admin Login</h1>
        <form onSubmit={handleSubmit}>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Enter admin password"
            className="w-full px-4 py-2 border rounded mb-4"
            disabled={isLoading}
          />
          {error && <div className="text-red-600 mb-4">{error}</div>}
          <button
            type="submit"
            disabled={isLoading || !password}
            className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50"
          >
            {isLoading ? 'Logging in...' : 'Login'}
          </button>
        </form>
      </div>
    </div>
  );
};
```


Component: AdminLayout
Location: /src/components/admin/AdminLayout.tsx

Purpose: Layout wrapper for admin pages with navigation

Props:
- children: React.ReactNode

Features:
- Sidebar navigation
- Admin header with logout button
- Protected route wrapper
- Session verification on mount

Navigation Items:
- Dashboard (default)
- Ticker Management
- Timestep Generator
- Player P&L
- Settings


Component: TickerManagement
Location: /src/pages/admin/TickerManagement.tsx

Purpose: CRUD interface for managing tickers

State:
- tickers: Ticker[]
- isLoading: boolean
- searchQuery: string
- sortConfig: { field: string; order: 'asc' | 'desc' }
- editingTicker: Ticker | null
- isUploadModalOpen: boolean

Features:
- Search/filter by symbol or name
- Sortable table columns
- Inline editing for trend/volatility/description
- Create new ticker form (modal)
- Bulk CSV upload (modal)
- Delete ticker with confirmation
- Real-time validation

Table Columns:
- Symbol
- Name
- Initial Price
- Trend
- Volatility
- Description (truncated with tooltip)
- Updated At
- Actions (Edit, Delete)


Component: CSVUploadModal
Location: /src/components/admin/CSVUploadModal.tsx

Purpose: Modal for bulk CSV ticker upload

Props:
- isOpen: boolean
- onClose: () => void
- onSuccess: () => void

State:
- file: File | null
- previewData: any[]
- validationErrors: ValidationError[]
- isUploading: boolean

Features:
- Drag-and-drop file upload
- CSV preview table
- Validation error display with line numbers
- Download template button
- Progress indicator during upload
- Summary report after upload


Component: TimestepGenerator
Location: /src/pages/admin/TimestepGenerator.tsx

Purpose: Interface for generating new market timesteps

State:
- previewPrices: PricePreview[]
- overrides: Record<symbol, price>
- isGenerating: boolean
- showConfirmModal: boolean

Features:
- "Generate Timestep" button
- Preview calculated prices
- Price override interface (editable table)
- Visual indicators for overridden prices
- Confirmation modal before generation
- Progress indicator during generation
- Success/error feedback

Preview Table Columns:
- Symbol
- Company Name
- Current Price
- Calculated Price
- Change %
- Override Price (editable)
- Actions (Reset override)


Component: PlayerPnLDashboard
Location: /src/pages/admin/PlayerPnLDashboard.tsx

Purpose: Monitor all player portfolios and P&L

State:
- players: PlayerPnL[]
- selectedPlayer: string | null
- sortConfig: SortConfig
- isLoading: boolean

Features:
- Sortable table of all players
- Color-coded P&L (green=profit, red=loss)
- Click row to view detailed holdings
- Export to CSV button
- Real-time updates via WebSocket
- Drill-down modal for player details

Table Columns:
- Character Name
- Total Value
- Cost Basis
- P/L Amount
- P/L %
- Holdings Count
- Last Transaction

Detail Modal:
- Individual holdings table
- Transaction history
- Charts (optional for v2)


Component: AdminSettings
Location: /src/pages/admin/AdminSettings.tsx

Purpose: Admin configuration and password management

State:
- currentPassword: string
- newPassword: string
- confirmPassword: string
- passwordStrength: PasswordStrength
- isChanging: boolean

Features:
- Change password form
- Password strength indicator
- Validation feedback
- Session timeout configuration
- Audit log viewer (optional for v2)


6.2 ENHANCED PLAYER COMPONENTS
-------------------------------

Component: SellModal (ENHANCED)
Location: /src/components/SellModal.tsx

Purpose: Modal for selling stocks from portfolio

Props:
- holding: Holding
- currentPrice: number
- onClose: () => void
- onSuccess: (result: TransactionResponse) => void

State:
- quantity: number
- estimatedProceeds: number
- estimatedPnL: number
- isSubmitting: boolean
- error: string | null

Features:
- Quantity input with max = current holdings
- Real-time calculation of proceeds and P/L
- Visual feedback (green for profit, red for loss)
- Confirmation step before execution
- Success modal with transaction details
- Error handling

UI Elements:
- Current holdings display
- Current price display
- Quantity slider/input (1 to max holdings)
- Estimated proceeds: quantity × current_price
- Estimated P/L: (current_price - avg_purchase_price) × quantity
- "Sell" button (disabled if quantity invalid)
- "Cancel" button


Component: CompanyTooltip (NEW)
Location: /src/components/CompanyTooltip.tsx

Purpose: Tooltip showing company description on hover

Props:
- symbol: string
- companyName: string
- currentPrice: number
- description: string
- children: React.ReactNode

Features:
- Hover trigger (desktop)
- Click trigger (mobile)
- Smart positioning (avoid screen edges)
- Smooth fade-in/fade-out
- Close button for mobile
- Renders above other content (z-index)

Implementation using Radix UI or Headless UI for accessibility


Component: Portfolio (ENHANCED)
Location: /src/pages/Portfolio.tsx

Enhancements:
- Add "Sell" button next to each holding
- Integrate CompanyTooltip on company names
- Show total realized P/L (from transaction history)
- Refresh on WebSocket events


Component: Market (ENHANCED)
Location: /src/pages/Market.tsx

Enhancements:
- Integrate CompanyTooltip on company names
- Show company descriptions in table (optional column)
- Add filter by description keywords
- Refresh when new tickers are added (WebSocket event)


6.3 CONTEXT & STATE MANAGEMENT
-------------------------------

Context: AdminAuthContext (NEW)
Location: /src/contexts/AdminAuthContext.tsx

Purpose: Manage admin authentication state

State:
- isAuthenticated: boolean
- sessionToken: string | null
- expiresAt: string | null

Methods:
- login(password: string): Promise<LoginResult>
- logout(): Promise<void>
- verifySession(): Promise<boolean>
- changePassword(current: string, newPwd: string): Promise<ChangePasswordResult>

Implementation:
```typescript
interface AdminAuthContextType {
  isAuthenticated: boolean;
  sessionToken: string | null;
  expiresAt: string | null;
  login: (password: string) => Promise<LoginResult>;
  logout: () => Promise<void>;
  verifySession: () => Promise<boolean>;
  changePassword: (current: string, newPwd: string) => Promise<ChangePasswordResult>;
}

export const AdminAuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [sessionToken, setSessionToken] = useState<string | null>(
    localStorage.getItem('admin_session_token')
  );
  const [expiresAt, setExpiresAt] = useState<string | null>(null);

  useEffect(() => {
    if (sessionToken) {
      verifySession();
    }
  }, [sessionToken]);

  const login = async (password: string): Promise<LoginResult> => {
    const response = await fetch('/api/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });

    const data = await response.json();

    if (data.success) {
      setSessionToken(data.session_token);
      setExpiresAt(data.expires_at);
      setIsAuthenticated(true);
      localStorage.setItem('admin_session_token', data.session_token);
    }

    return data;
  };

  const logout = async () => {
    if (sessionToken) {
      await fetch('/api/admin/logout', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
    }

    setSessionToken(null);
    setExpiresAt(null);
    setIsAuthenticated(false);
    localStorage.removeItem('admin_session_token');
  };

  const verifySession = async (): Promise<boolean> => {
    if (!sessionToken) return false;

    const response = await fetch('/api/admin/verify', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });

    const data = await response.json();

    if (data.valid) {
      setIsAuthenticated(true);
      setExpiresAt(data.expires_at);
      return true;
    } else {
      logout();
      return false;
    }
  };

  const changePassword = async (current: string, newPwd: string) => {
    const response = await fetch('/api/admin/change-password', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${sessionToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        current_password: current,
        new_password: newPwd,
        confirm_password: newPwd
      })
    });

    return await response.json();
  };

  return (
    <AdminAuthContext.Provider value={{
      isAuthenticated,
      sessionToken,
      expiresAt,
      login,
      logout,
      verifySession,
      changePassword
    }}>
      {children}
    </AdminAuthContext.Provider>
  );
};
```


Context: AppContext (ENHANCED)
Location: /src/contexts/AppContext.tsx

Enhancements:
- Add companies state with descriptions
- Subscribe to ticker_created/ticker_updated WebSocket events
- Expose getCompanyDescription(symbol) helper


6.4 ROUTING STRUCTURE
----------------------

Updated App.tsx routing:

```typescript
<Routes>
  {/* Player Routes */}
  <Route path="/" element={<Login />} />
  <Route path="/dashboard" element={
    <ProtectedRoute>
      <AppLayout><Portfolio /></AppLayout>
    </ProtectedRoute>
  } />
  <Route path="/market" element={
    <ProtectedRoute>
      <AppLayout><Market /></AppLayout>
    </ProtectedRoute>
  } />

  {/* Admin Routes */}
  <Route path="/admin" element={<AdminLogin />} />
  <Route path="/admin/dashboard" element={
    <AdminProtectedRoute>
      <AdminLayout><PlayerPnLDashboard /></AdminLayout>
    </AdminProtectedRoute>
  } />
  <Route path="/admin/tickers" element={
    <AdminProtectedRoute>
      <AdminLayout><TickerManagement /></AdminLayout>
    </AdminProtectedRoute>
  } />
  <Route path="/admin/timestep" element={
    <AdminProtectedRoute>
      <AdminLayout><TimestepGenerator /></AdminLayout>
    </AdminProtectedRoute>
  } />
  <Route path="/admin/settings" element={
    <AdminProtectedRoute>
      <AdminLayout><AdminSettings /></AdminLayout>
    </AdminProtectedRoute>
  } />

  <Route path="*" element={<Navigate to="/" replace />} />
</Routes>
```


================================================================================
7. AUTHENTICATION & SECURITY
================================================================================

7.1 PASSWORD HASHING
---------------------

Library: bcrypt (Python: bcrypt package, already popular)

Configuration:
- Cost factor: 12 (balances security and performance)
- Salt rounds: automatically handled by bcrypt

Implementation (backend):
```python
import bcrypt

def hash_password(password: str) -> tuple[str, str]:
    """Hash password with bcrypt."""
    salt = bcrypt.gensalt(rounds=12)
    password_hash = bcrypt.hashpw(password.encode('utf-8'), salt)
    return password_hash.decode('utf-8'), salt.decode('utf-8')

def verify_password(password: str, password_hash: str) -> bool:
    """Verify password against hash."""
    return bcrypt.checkpw(
        password.encode('utf-8'),
        password_hash.encode('utf-8')
    )
```


7.2 SESSION MANAGEMENT
----------------------

Token Generation:
```python
import uuid
from datetime import datetime, timedelta

def create_session(db: Database, ip_address: str, user_agent: str) -> tuple[str, datetime]:
    """Create new admin session."""
    session_token = str(uuid.uuid4())
    config = db.get_admin_config()

    created_at = datetime.now()
    expires_at = created_at + timedelta(hours=config.session_timeout_hours)

    db.save_session({
        'session_token': session_token,
        'created_at': created_at.isoformat(),
        'expires_at': expires_at.isoformat(),
        'last_activity': created_at.isoformat(),
        'ip_address': ip_address,
        'user_agent': user_agent
    })

    return session_token, expires_at
```

Session Verification Middleware:
```python
from fastapi import HTTPException, Request
from functools import wraps

async def verify_admin_session(request: Request) -> bool:
    """Middleware to verify admin session."""
    auth_header = request.headers.get('Authorization')

    if not auth_header or not auth_header.startswith('Bearer '):
        raise HTTPException(status_code=401, detail="Missing or invalid authorization header")

    session_token = auth_header.replace('Bearer ', '')

    session = db.get_session(session_token)

    if not session:
        raise HTTPException(status_code=401, detail="Invalid session token")

    # Check expiration
    expires_at = datetime.fromisoformat(session['expires_at'])
    if datetime.now() > expires_at:
        db.delete_session(session_token)
        raise HTTPException(status_code=401, detail="Session expired")

    # Update last activity
    db.update_session_activity(session_token)

    return True
```

Apply to admin routes:
```python
from fastapi import Depends

@app.get("/api/admin/tickers", dependencies=[Depends(verify_admin_session)])
async def get_tickers():
    # Admin route logic
    pass
```


7.3 RATE LIMITING
-----------------

Implementation for login endpoint:

```python
from collections import defaultdict
from datetime import datetime, timedelta
import asyncio

class RateLimiter:
    def __init__(self, max_attempts: int = 5, window_minutes: int = 1):
        self.max_attempts = max_attempts
        self.window = timedelta(minutes=window_minutes)
        self.attempts = defaultdict(list)  # ip -> [timestamps]

    def is_allowed(self, ip_address: str) -> bool:
        """Check if IP is allowed to make request."""
        now = datetime.now()
        cutoff = now - self.window

        # Remove old attempts
        self.attempts[ip_address] = [
            timestamp for timestamp in self.attempts[ip_address]
            if timestamp > cutoff
        ]

        # Check if under limit
        if len(self.attempts[ip_address]) >= self.max_attempts:
            return False

        # Record new attempt
        self.attempts[ip_address].append(now)
        return True

login_rate_limiter = RateLimiter(max_attempts=5, window_minutes=1)

@app.post("/api/admin/login")
async def admin_login(request: Request, credentials: AdminLoginRequest):
    ip_address = request.client.host

    if not login_rate_limiter.is_allowed(ip_address):
        raise HTTPException(
            status_code=429,
            detail="Too many login attempts. Please try again later."
        )

    # Continue with login logic...
```


7.4 CSRF PROTECTION
-------------------

For admin forms, implement CSRF tokens:

```python
import secrets

@app.get("/api/admin/csrf-token", dependencies=[Depends(verify_admin_session)])
async def get_csrf_token(request: Request):
    """Generate CSRF token for admin forms."""
    csrf_token = secrets.token_urlsafe(32)

    # Store in session or Redis (for simplicity, using in-memory dict)
    # In production, use Redis or database
    csrf_tokens[csrf_token] = datetime.now()

    return {"csrf_token": csrf_token}

def verify_csrf_token(token: str) -> bool:
    """Verify CSRF token is valid."""
    if token not in csrf_tokens:
        return False

    # Check if token is expired (15 minutes)
    created_at = csrf_tokens[token]
    if datetime.now() - created_at > timedelta(minutes=15):
        del csrf_tokens[token]
        return False

    # Token is valid, remove it (one-time use)
    del csrf_tokens[token]
    return True
```

Frontend usage:
```typescript
// Fetch CSRF token before form submission
const csrfToken = await fetch('/api/admin/csrf-token').then(r => r.json());

// Include in form submission
await fetch('/api/admin/tickers', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${sessionToken}`,
    'X-CSRF-Token': csrfToken.csrf_token
  },
  body: JSON.stringify(formData)
});
```


7.5 INPUT VALIDATION & SANITIZATION
------------------------------------

Backend validation using Pydantic:

```python
from pydantic import BaseModel, Field, validator
import re

class CreateTickerRequest(BaseModel):
    symbol: str = Field(..., min_length=1, max_length=10)
    name: str = Field(..., min_length=1, max_length=100)
    initial_price: float = Field(..., gt=0)
    trend: float = Field(..., ge=-1.0, le=1.0)
    volatility: float = Field(..., ge=0, le=2.0)
    description: str = Field(default='', max_length=500)

    @validator('symbol')
    def validate_symbol(cls, v):
        # Must be uppercase alphanumeric
        if not re.match(r'^[A-Z0-9]+$', v):
            raise ValueError('Symbol must be uppercase alphanumeric')
        return v

    @validator('description')
    def sanitize_description(cls, v):
        # Remove potential XSS vectors
        # In production, use a library like bleach
        return v.replace('<', '&lt;').replace('>', '&gt;')
```

Frontend validation:

```typescript
const validateTickerForm = (data: TickerFormData): ValidationErrors => {
  const errors: ValidationErrors = {};

  if (!data.symbol || !/^[A-Z0-9]+$/.test(data.symbol)) {
    errors.symbol = 'Symbol must be uppercase alphanumeric';
  }

  if (!data.name || data.name.length < 1) {
    errors.name = 'Name is required';
  }

  if (!data.initial_price || data.initial_price <= 0) {
    errors.initial_price = 'Initial price must be positive';
  }

  if (data.trend < -1.0 || data.trend > 1.0) {
    errors.trend = 'Trend must be between -1.0 and 1.0';
  }

  if (data.volatility < 0 || data.volatility > 2.0) {
    errors.volatility = 'Volatility must be between 0 and 2.0';
  }

  if (data.description && data.description.length > 500) {
    errors.description = 'Description must be 500 characters or less';
  }

  return errors;
};
```


7.6 SECURITY CHECKLIST
----------------------

Backend:
- [x] Password hashing with bcrypt (cost=12)
- [x] Session token generation with UUID v4
- [x] Session expiration (24 hours default)
- [x] Rate limiting on login endpoint (5 attempts/minute)
- [x] CSRF token validation on state-changing requests
- [x] SQL injection prevention (parameterized queries)
- [x] Input validation with Pydantic
- [x] Authorization middleware on admin routes
- [x] Audit logging for all admin actions
- [x] Password history (prevent reuse of last 3)
- [x] HTTPS enforcement (production)
- [x] CORS configuration (restrict origins in production)

Frontend:
- [x] Session token stored in localStorage (consider httpOnly cookie for production)
- [x] Automatic session verification on app load
- [x] Logout on session expiration
- [x] Input sanitization before display (XSS prevention)
- [x] Form validation before submission
- [x] Secure password input (type="password", no autocomplete)
- [x] Clear session data on logout
- [x] CSRF token inclusion in form submissions


================================================================================
8. MIGRATION STRATEGY
================================================================================

8.1 MIGRATION PHASES
--------------------

PHASE 1: Database Schema Migration (Week 1, Day 1-2)
-----------------------------------------------------

Steps:
1. Backup existing database
2. Run migration script to create new tables
3. Populate companies table from existing data sources
4. Verify data integrity

Commands:
```bash
# Backup database
cp backend/galactic_market.db backend/galactic_market.db.backup

# Run migration
python backend/migrate_v2.py

# Verify
python backend/verify_migration.py
```

Migration Script (migrate_v2.py):
```python
import sqlite3
from datetime import datetime
import bcrypt
import json

def migrate_database(db_path: str):
    """Run v2 migration."""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    print("Starting migration to v2...")

    # Read migration SQL
    with open('migration_v2.sql', 'r') as f:
        migration_sql = f.read()

    # Execute migration
    cursor.executescript(migration_sql)

    print("Created new tables and indexes")

    # Populate companies from Google Sheets or CSV
    print("Importing company data...")
    companies = load_companies_from_source()

    for company in companies:
        cursor.execute("""
            INSERT OR IGNORE INTO companies
            (symbol, name, initial_price, trend, volatility, description, created_at, updated_at, created_by)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            company['symbol'],
            company['name'],
            company['initial_price'],
            company['trend'],
            company['volatility'],
            company.get('description', ''),
            datetime.now().isoformat(),
            datetime.now().isoformat(),
            'migration'
        ))

    print(f"Imported {len(companies)} companies")

    # Hash default admin password
    password = "admin"
    salt = bcrypt.gensalt(rounds=12)
    password_hash = bcrypt.hashpw(password.encode('utf-8'), salt)

    # Update admin_config with actual hash
    cursor.execute("""
        UPDATE admin_config
        SET password_hash = ?, password_salt = ?
        WHERE id = 1
    """, (password_hash.decode('utf-8'), salt.decode('utf-8')))

    print("Initialized admin credentials (default password: 'admin')")

    conn.commit()
    conn.close()

    print("Migration completed successfully!")

def load_companies_from_source():
    """Load companies from Google Sheets or CSV."""
    # Option 1: From Google Sheets (if still connected)
    try:
        from google_sheets import GoogleSheetsClient
        sheets = GoogleSheetsClient()
        companies = sheets.get_companies()
        return companies
    except:
        pass

    # Option 2: From CSV file
    import csv
    companies = []
    with open('companies_export.csv', 'r') as f:
        reader = csv.DictReader(f)
        for row in reader:
            companies.append({
                'symbol': row['symbol'].upper(),
                'name': row['name'],
                'initial_price': float(row['initial_price']),
                'trend': float(row['trend']),
                'volatility': float(row['volatility']),
                'description': row.get('description', '')
            })
    return companies

if __name__ == '__main__':
    migrate_database('galactic_market.db')
```


PHASE 2: Backend Implementation (Week 1, Day 3-5)
--------------------------------------------------

Implementation Order:
1. Create new models (AdminConfig, AdminSession, AuditLog)
2. Implement auth service (login, verify, change password)
3. Add admin API endpoints (tickers, timestep, players)
4. Implement CSV upload processor
5. Add audit logging to all admin actions
6. Update existing endpoints (sell transaction)
7. Write unit tests for new functionality

Testing Checkpoints:
- [ ] Admin login successful with default password
- [ ] Admin login fails with wrong password
- [ ] Session expires after timeout
- [ ] Create ticker via API
- [ ] Bulk upload CSV
- [ ] Update ticker parameters
- [ ] Generate timestep with overrides
- [ ] View player P&L data
- [ ] Change admin password
- [ ] Sell stock transaction


PHASE 3: Frontend Implementation (Week 2, Day 1-3)
---------------------------------------------------

Implementation Order:
1. Create AdminAuthContext
2. Build AdminLogin component
3. Build AdminLayout with navigation
4. Build TickerManagement page
5. Build CSVUploadModal
6. Build TimestepGenerator page
7. Build PlayerPnLDashboard
8. Build AdminSettings page
9. Enhance SellModal for players
10. Add CompanyTooltip component
11. Update routing in App.tsx
12. Add admin routes to Header navigation (conditional)

Testing Checkpoints:
- [ ] Admin can log in and access dashboard
- [ ] Admin can create ticker via form
- [ ] Admin can upload CSV with validation
- [ ] Admin can update ticker parameters
- [ ] Admin can generate timestep with overrides
- [ ] Admin can view player P&L
- [ ] Admin can change password
- [ ] Player can sell stocks
- [ ] Player sees company descriptions on hover
- [ ] WebSocket updates work for both player and admin


PHASE 4: Data Migration from Google Sheets (Week 2, Day 4)
-----------------------------------------------------------

Steps:
1. Export current company data from Google Sheets to CSV
2. Verify CSV format matches required schema
3. Run bulk upload via admin panel
4. Verify all tickers imported correctly
5. Update any missing descriptions manually
6. Disable Google Sheets integration (keep as fallback)

CSV Export Template:
```csv
symbol,name,initial_price,trend,volatility,description
AEON,Aeon Industries,100.00,0.05,0.2,"Leading manufacturer of energy shields and defensive technologies"
VOID,Void Transport,50.00,-0.02,0.3,"Interstellar shipping and logistics across the galaxy"
STAR,StarForge Corp,150.00,0.08,0.15,"Premier weapons manufacturing conglomerate"
```

Verification Script:
```python
def verify_migration():
    """Verify all companies migrated successfully."""
    db = Database()
    companies_db = db.get_all_companies()
    companies_sheets = sheets_client.get_companies()

    print(f"Database companies: {len(companies_db)}")
    print(f"Sheets companies: {len(companies_sheets)}")

    missing = []
    for sheet_company in companies_sheets:
        if not any(c.symbol == sheet_company['symbol'] for c in companies_db):
            missing.append(sheet_company['symbol'])

    if missing:
        print(f"Missing companies: {missing}")
    else:
        print("All companies migrated successfully!")
```


PHASE 5: Testing & QA (Week 2, Day 5)
--------------------------------------

Test Scenarios:

Admin Functionality:
1. Login with default password "admin"
2. Change password to "newPassword123"
3. Logout and login with new password
4. Create ticker "TEST" with all fields
5. Upload CSV with 10 tickers (mix of new and existing)
6. Update trend for ticker "AEON"
7. Generate timestep without overrides
8. Generate timestep with override for "VOID" = 100.00
9. View player P&L dashboard
10. Export player data to CSV
11. Attempt to delete ticker with transactions (should fail)
12. Delete ticker without transactions (should succeed)

Player Functionality:
1. Buy 10 shares of "AEON"
2. Sell 5 shares of "AEON"
3. Hover over "AEON" in market view (tooltip appears)
4. Hover over "AEON" in portfolio (tooltip appears)
5. Attempt to sell more shares than owned (should fail)
6. Sell all remaining shares (holding should disappear)

Security Testing:
1. Attempt to access /admin/dashboard without login (should redirect)
2. Attempt to call admin API without session token (should 401)
3. Attempt login with wrong password 6 times (should rate limit)
4. Verify session expires after 24 hours
5. Verify password cannot be reused (last 3)
6. Verify SQL injection attempts are blocked
7. Verify XSS in description field is sanitized

Performance Testing:
1. Upload CSV with 1000 rows (should complete in <5s)
2. Generate timestep with 50 tickers (should complete in <3s)
3. Load player P&L with 20 players (should load in <2s)
4. Sell transaction (should complete in <500ms)


PHASE 6: Deployment & Documentation (Week 3, Day 1)
----------------------------------------------------

Deployment Steps:
1. Merge feature branch to main
2. Run database migration on production database
3. Update environment variables (if any)
4. Build frontend production bundle
5. Deploy backend and frontend
6. Verify health checks
7. Monitor logs for errors

Post-Deployment:
1. Send announcement to game master with new admin URL
2. Provide training session on admin panel features
3. Share CSV template and documentation
4. Set up monitoring alerts for admin actions
5. Create backup schedule for database

Documentation:
1. Update README.md with new features
2. Create ADMIN_GUIDE.md with screenshots
3. Create CSV_TEMPLATE.md with examples
4. Update API documentation
5. Create MIGRATION_GUIDE.md for future reference


8.2 ROLLBACK PLAN
-----------------

If critical issues arise during migration:

1. Restore database from backup:
```bash
cp backend/galactic_market.db.backup backend/galactic_market.db
```

2. Revert to previous code version:
```bash
git revert <migration-commit-hash>
```

3. Re-enable Google Sheets integration (if disabled)

4. Notify users of rollback

5. Investigate issues before retry


8.3 BACKWARD COMPATIBILITY
---------------------------

During transition period:
- Keep Google Sheets integration as read-only fallback
- Existing player endpoints remain unchanged
- WebSocket events maintain same format
- Database schema changes are additive (no destructive changes)
- API versioning for admin endpoints (/api/v2/admin/*)


================================================================================
9. TESTING REQUIREMENTS
================================================================================

9.1 BACKEND UNIT TESTS
----------------------

Test Coverage Requirements: >80%

Test Files:
- test_admin_auth.py
- test_admin_api.py
- test_ticker_crud.py
- test_csv_processor.py
- test_sell_transaction.py

Example: test_admin_auth.py
```python
import pytest
from database import Database
from auth_service import AuthService

@pytest.fixture
def auth_service():
    db = Database(':memory:')
    return AuthService(db)

def test_login_success(auth_service):
    """Test successful admin login."""
    result = auth_service.login('admin', '127.0.0.1', 'test-agent')
    assert result['success'] == True
    assert 'session_token' in result
    assert 'expires_at' in result

def test_login_wrong_password(auth_service):
    """Test login with wrong password."""
    result = auth_service.login('wrongpassword', '127.0.0.1', 'test-agent')
    assert result['success'] == False
    assert 'error' in result

def test_verify_valid_session(auth_service):
    """Test session verification."""
    login_result = auth_service.login('admin', '127.0.0.1', 'test-agent')
    session_token = login_result['session_token']

    is_valid = auth_service.verify_session(session_token)
    assert is_valid == True

def test_verify_invalid_session(auth_service):
    """Test invalid session verification."""
    is_valid = auth_service.verify_session('invalid-token')
    assert is_valid == False

def test_change_password(auth_service):
    """Test password change."""
    login_result = auth_service.login('admin', '127.0.0.1', 'test-agent')
    session_token = login_result['session_token']

    result = auth_service.change_password(
        session_token, 'admin', 'newPassword123'
    )
    assert result['success'] == True

    # Verify old password no longer works
    old_login = auth_service.login('admin', '127.0.0.1', 'test-agent')
    assert old_login['success'] == False

    # Verify new password works
    new_login = auth_service.login('newPassword123', '127.0.0.1', 'test-agent')
    assert new_login['success'] == True

def test_password_reuse_prevention(auth_service):
    """Test that passwords cannot be reused."""
    # Change password 3 times
    # ... test implementation
    pass
```


9.2 FRONTEND UNIT TESTS
-----------------------

Test Coverage Requirements: >70%

Testing Library: React Testing Library + Jest

Test Files:
- AdminLogin.test.tsx
- TickerManagement.test.tsx
- CSVUploadModal.test.tsx
- SellModal.test.tsx
- CompanyTooltip.test.tsx

Example: SellModal.test.tsx
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { SellModal } from './SellModal';
import { rest } from 'msw';
import { setupServer } from 'msw/node';

const mockHolding = {
  symbol: 'AEON',
  quantity: 100,
  avg_purchase_price: 98.50,
  current_price: 110.00,
  current_value: 11000.00,
  profit_loss: 1150.00,
  profit_loss_percentage: 11.68
};

const server = setupServer(
  rest.post('/api/transaction/sell', (req, res, ctx) => {
    return res(ctx.json({
      success: true,
      transaction_id: 123,
      message: 'Sold successfully',
      details: {
        symbol: 'AEON',
        quantity_sold: 10,
        sale_price: 110.00,
        total_proceeds: 1100.00,
        realized_profit_loss: 115.00
      }
    }));
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('SellModal', () => {
  test('renders with holding information', () => {
    render(
      <SellModal
        holding={mockHolding}
        currentPrice={110.00}
        onClose={jest.fn()}
        onSuccess={jest.fn()}
      />
    );

    expect(screen.getByText(/AEON/i)).toBeInTheDocument();
    expect(screen.getByText(/100/i)).toBeInTheDocument();
  });

  test('calculates proceeds correctly', () => {
    render(
      <SellModal
        holding={mockHolding}
        currentPrice={110.00}
        onClose={jest.fn()}
        onSuccess={jest.fn()}
      />
    );

    const quantityInput = screen.getByLabelText(/quantity/i);
    fireEvent.change(quantityInput, { target: { value: '10' } });

    expect(screen.getByText(/1,100.00/i)).toBeInTheDocument(); // proceeds
    expect(screen.getByText(/115.00/i)).toBeInTheDocument(); // P/L
  });

  test('prevents selling more than owned', () => {
    render(
      <SellModal
        holding={mockHolding}
        currentPrice={110.00}
        onClose={jest.fn()}
        onSuccess={jest.fn()}
      />
    );

    const quantityInput = screen.getByLabelText(/quantity/i);
    fireEvent.change(quantityInput, { target: { value: '150' } });

    const sellButton = screen.getByRole('button', { name: /sell/i });
    expect(sellButton).toBeDisabled();
  });

  test('submits sell transaction successfully', async () => {
    const onSuccess = jest.fn();

    render(
      <SellModal
        holding={mockHolding}
        currentPrice={110.00}
        onClose={jest.fn()}
        onSuccess={onSuccess}
      />
    );

    const quantityInput = screen.getByLabelText(/quantity/i);
    fireEvent.change(quantityInput, { target: { value: '10' } });

    const sellButton = screen.getByRole('button', { name: /sell/i });
    fireEvent.click(sellButton);

    await waitFor(() => {
      expect(onSuccess).toHaveBeenCalledWith(expect.objectContaining({
        success: true
      }));
    });
  });
});
```


9.3 INTEGRATION TESTS
---------------------

End-to-End Test Scenarios:

Test: Complete Admin Workflow
```python
def test_complete_admin_workflow(client):
    """Test complete admin workflow from login to timestep generation."""

    # 1. Login
    response = client.post('/api/admin/login', json={'password': 'admin'})
    assert response.status_code == 200
    session_token = response.json()['session_token']
    headers = {'Authorization': f'Bearer {session_token}'}

    # 2. Create ticker
    response = client.post('/api/admin/tickers', headers=headers, json={
        'symbol': 'TEST',
        'name': 'Test Company',
        'initial_price': 100.00,
        'trend': 0.05,
        'volatility': 0.2,
        'description': 'Test description'
    })
    assert response.status_code == 201

    # 3. Update ticker
    response = client.put('/api/admin/tickers/TEST', headers=headers, json={
        'trend': 0.08,
        'volatility': 0.25
    })
    assert response.status_code == 200

    # 4. Generate timestep
    response = client.post('/api/admin/timestep', headers=headers, json={
        'overrides': {'TEST': 105.00}
    })
    assert response.status_code == 200
    assert response.json()['prices']['TEST'] == 105.00

    # 5. Verify price was saved
    response = client.get('/api/market')
    assert response.status_code == 200
    assert response.json()['prices']['TEST'] == 105.00
```

Test: Complete Player Workflow
```python
def test_complete_player_workflow(client):
    """Test player buy and sell workflow."""

    # 1. Buy stock
    response = client.post('/api/transaction/buy', json={
        'character_name': 'TestPlayer',
        'symbol': 'AEON',
        'quantity': 10
    })
    assert response.status_code == 200

    # 2. Check portfolio
    response = client.get('/api/portfolio/TestPlayer')
    assert response.status_code == 200
    holdings = response.json()['holdings']
    assert len(holdings) == 1
    assert holdings[0]['symbol'] == 'AEON'
    assert holdings[0]['quantity'] == 10

    # 3. Sell stock
    response = client.post('/api/transaction/sell', json={
        'character_name': 'TestPlayer',
        'symbol': 'AEON',
        'quantity': 5
    })
    assert response.status_code == 200

    # 4. Verify updated portfolio
    response = client.get('/api/portfolio/TestPlayer')
    holdings = response.json()['holdings']
    assert holdings[0]['quantity'] == 5
```


9.4 MANUAL TESTING CHECKLIST
-----------------------------

Admin Panel:
- [ ] Login with default password
- [ ] Login fails with wrong password
- [ ] Session persists across page refresh
- [ ] Session expires after timeout
- [ ] Change password successfully
- [ ] Cannot reuse old password
- [ ] Create ticker via form
- [ ] Upload CSV with 10 tickers
- [ ] CSV upload shows validation errors
- [ ] Update ticker trend/volatility
- [ ] Generate timestep without overrides
- [ ] Generate timestep with overrides
- [ ] Override prices show in history
- [ ] Player P&L dashboard loads
- [ ] Player P&L data is accurate
- [ ] Drill-down shows individual holdings
- [ ] Export CSV works
- [ ] Delete ticker without transactions
- [ ] Cannot delete ticker with transactions
- [ ] Audit log records all actions
- [ ] Logout clears session

Player Features:
- [ ] Sell button appears on holdings
- [ ] Sell modal shows correct data
- [ ] Quantity validation works
- [ ] Sell transaction executes
- [ ] Success modal shows proceeds and P/L
- [ ] Portfolio updates after sale
- [ ] Company tooltip appears on hover
- [ ] Tooltip shows description
- [ ] Tooltip positions correctly
- [ ] Tooltip works on mobile (tap)

WebSocket Updates:
- [ ] New timestep updates all clients
- [ ] New ticker appears in market
- [ ] Updated ticker reflects changes
- [ ] Multiple clients receive updates


================================================================================
10. IMPLEMENTATION TIMELINE
================================================================================

10.1 DETAILED SCHEDULE
----------------------

WEEK 1: Backend Development
----------------------------

Day 1 (8 hours):
- [2h] Database schema design and migration script
- [2h] Run migration and verify data integrity
- [2h] Create new models (AdminConfig, AdminSession, etc.)
- [2h] Implement password hashing and session management

Day 2 (8 hours):
- [3h] Implement admin authentication endpoints (login, verify, logout)
- [2h] Implement password change endpoint
- [2h] Add rate limiting and CSRF protection
- [1h] Write unit tests for auth service

Day 3 (8 hours):
- [3h] Implement ticker CRUD endpoints
- [2h] Implement CSV upload processor
- [2h] Add validation and error handling
- [1h] Write unit tests for ticker management

Day 4 (8 hours):
- [3h] Enhance timestep generation endpoint with overrides
- [2h] Implement player P&L endpoints
- [2h] Add audit logging to all admin actions
- [1h] Write unit tests

Day 5 (8 hours):
- [2h] Implement sell transaction endpoint
- [2h] Add companies public endpoint
- [2h] Integration testing
- [2h] Bug fixes and refinements


WEEK 2: Frontend Development
-----------------------------

Day 1 (8 hours):
- [2h] Create AdminAuthContext
- [2h] Build AdminLogin component
- [2h] Build AdminLayout with navigation
- [2h] Set up admin routing

Day 2 (8 hours):
- [4h] Build TickerManagement page
- [2h] Build CreateTickerModal
- [2h] Build CSVUploadModal

Day 3 (8 hours):
- [3h] Build TimestepGenerator page
- [2h] Build PriceOverrideTable component
- [3h] Build PlayerPnLDashboard page

Day 4 (8 hours):
- [2h] Build AdminSettings page
- [2h] Enhance SellModal component
- [2h] Build CompanyTooltip component
- [2h] Update Market and Portfolio pages

Day 5 (8 hours):
- [3h] Integration testing (frontend + backend)
- [2h] UI/UX refinements
- [2h] Bug fixes
- [1h] Performance optimization


WEEK 3: Testing & Deployment
-----------------------------

Day 1 (8 hours):
- [4h] Manual testing (admin features)
- [2h] Manual testing (player features)
- [2h] Security testing

Day 2 (8 hours):
- [3h] Bug fixes from testing
- [2h] Data migration from Google Sheets
- [2h] Verify migration success
- [1h] Final integration testing

Day 3 (8 hours):
- [2h] Documentation (README, ADMIN_GUIDE)
- [2h] Deployment preparation
- [2h] Production deployment
- [2h] Post-deployment verification

Day 4 (4 hours):
- [2h] GM training session
- [1h] Monitor production logs
- [1h] Address any issues

TOTAL: 140 hours (3.5 weeks at 40 hours/week)


10.2 MILESTONES
---------------

M1: Database Migration Complete (Week 1, Day 1)
- All new tables created
- Data migrated successfully
- Backward compatibility verified

M2: Backend API Complete (Week 1, Day 5)
- All admin endpoints implemented
- Sell transaction endpoint working
- Unit tests passing (>80% coverage)

M3: Admin Panel Functional (Week 2, Day 3)
- Admin can log in and manage tickers
- Admin can generate timesteps with overrides
- Admin can view player P&L

M4: Player Features Complete (Week 2, Day 4)
- Players can sell stocks
- Company descriptions visible in tooltips
- WebSocket updates working

M5: Testing Complete (Week 3, Day 2)
- All manual tests passed
- Integration tests passing
- Security tests passed

M6: Production Deployment (Week 3, Day 3)
- Code deployed to production
- Database migrated
- GM trained on new features


10.3 DEPENDENCIES & CRITICAL PATH
----------------------------------

Critical Path:
Database Migration → Backend Auth → Backend Ticker API → Frontend Admin Panel → Testing → Deployment

Dependencies:
- Backend ticker API requires database migration
- Frontend admin panel requires backend auth and ticker API
- Player sell feature requires backend sell endpoint
- Company tooltips require companies endpoint
- All testing requires both frontend and backend complete

Parallel Work Opportunities:
- While backend auth is being developed, database migration can be tested
- While backend ticker API is being developed, frontend auth components can be built
- Frontend player enhancements can be developed in parallel with admin panel


================================================================================
11. RISK ASSESSMENT & MITIGATION
================================================================================

11.1 TECHNICAL RISKS
--------------------

RISK-T1: Database Migration Failure
Severity: HIGH
Probability: LOW
Impact: Application downtime, data loss

Mitigation:
- Create backup before migration
- Test migration on copy of production database first
- Write verification script to check data integrity
- Implement rollback procedure
- Run migration during low-traffic period

RISK-T2: Password Security Vulnerability
Severity: HIGH
Probability: MEDIUM
Impact: Unauthorized admin access, game manipulation

Mitigation:
- Use industry-standard bcrypt with cost factor 12
- Implement rate limiting on login attempts
- Add CSRF protection
- Enforce password strength requirements
- Log all authentication attempts
- Monitor for suspicious activity

RISK-T3: CSV Upload Vulnerabilities
Severity: MEDIUM
Probability: MEDIUM
Impact: Malicious data injection, XSS attacks

Mitigation:
- Validate CSV structure before processing
- Sanitize all text inputs (especially description)
- Limit file size (max 1MB)
- Limit row count (max 1000 rows)
- Validate data types and ranges
- Use parameterized queries for database insertion
- Run upload in isolated transaction (atomic)

RISK-T4: WebSocket Connection Instability
Severity: MEDIUM
Probability: MEDIUM
Impact: Clients not receiving real-time updates

Mitigation:
- Implement automatic reconnection logic
- Add heartbeat/ping-pong for connection health
- Fall back to polling if WebSocket fails
- Queue messages during disconnection
- Show connection status indicator in UI

RISK-T5: Performance Degradation with Scale
Severity: MEDIUM
Probability: LOW
Impact: Slow admin operations, poor UX

Mitigation:
- Add database indexes on frequently queried columns
- Implement caching for company data (5-minute TTL)
- Paginate large result sets (player P&L, transactions)
- Optimize CSV processing (batch inserts)
- Monitor query performance
- Set timeouts on long-running operations


11.2 OPERATIONAL RISKS
----------------------

RISK-O1: GM Loses Admin Password
Severity: MEDIUM
Probability: MEDIUM
Impact: Cannot access admin panel

Mitigation:
- Document password reset procedure (requires database access)
- Create emergency password reset script for server admin
- Encourage GM to store password securely (password manager)
- Add password recovery email option (future enhancement)

Emergency Reset Script:
```python
# reset_admin_password.py
import bcrypt
from database import Database

def reset_password(new_password: str):
    db = Database()
    salt = bcrypt.gensalt(rounds=12)
    password_hash = bcrypt.hashpw(new_password.encode('utf-8'), salt)

    db.execute("""
        UPDATE admin_config
        SET password_hash = ?, password_salt = ?, last_password_change = datetime('now')
        WHERE id = 1
    """, (password_hash.decode('utf-8'), salt.decode('utf-8')))

    print(f"Admin password reset to: {new_password}")
    print("Please change this password immediately after logging in.")

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 2:
        print("Usage: python reset_admin_password.py <new_password>")
        sys.exit(1)

    reset_password(sys.argv[1])
```

RISK-O2: Accidental Ticker Deletion
Severity: MEDIUM
Probability: LOW
Impact: Historical data loss, player confusion

Mitigation:
- Require confirmation dialog before deletion
- Prevent deletion if transactions exist
- Implement soft delete (mark as inactive instead of hard delete)
- Add "Restore" functionality for soft-deleted tickers
- Log all deletions to audit log
- Show warning about irreversibility

RISK-O3: Incorrect Price Override
Severity: LOW
Probability: MEDIUM
Impact: Unfair market manipulation, player complaints

Mitigation:
- Show calculated price vs override price for comparison
- Highlight overridden prices in red/yellow
- Require confirmation before applying overrides
- Mark overridden prices in database and price history
- Allow GM to view override history
- Document best practices for price overrides

RISK-O4: Concurrent Timestep Generation
Severity: MEDIUM
Probability: LOW
Impact: Data corruption, duplicate timesteps

Mitigation:
- Implement generation lock in database
- Return 409 error if generation in progress
- Show lock status in UI
- Auto-release lock after timeout (5 minutes)
- Log all generation attempts
- Add "Force Unlock" button for emergencies (admin only)


11.3 USER EXPERIENCE RISKS
---------------------------

RISK-U1: Confusing Admin Interface
Severity: MEDIUM
Probability: MEDIUM
Impact: GM makes mistakes, support burden

Mitigation:
- Conduct usability testing with GM before deployment
- Provide clear labels and help text
- Add tooltips for complex features
- Create comprehensive admin guide with screenshots
- Offer training session for GM
- Add contextual help links in UI

RISK-U2: Players Accidentally Navigate to Admin Panel
Severity: LOW
Probability: HIGH
Impact: Confusion, attempted unauthorized access

Mitigation:
- Don't show admin link in player navigation
- Admin URL not discoverable from player pages
- Password protection on admin panel
- Clear messaging: "Admin Access Only"
- Rate limit login attempts to prevent brute force
- Log failed login attempts

RISK-U3: Tooltip Obstructs Important UI Elements
Severity: LOW
Probability: MEDIUM
Impact: Poor UX, difficulty interacting with interface

Mitigation:
- Implement smart positioning (avoid edges)
- Add slight delay before showing (200ms)
- Close on click outside
- Use semi-transparent background
- Limit tooltip width
- Test on different screen sizes


11.4 BUSINESS CONTINUITY RISKS
-------------------------------

RISK-B1: Single Admin Account (No Multi-User)
Severity: LOW
Probability: N/A
Impact: Only one person can administer

Mitigation:
- Document limitation in README
- Consider multi-admin support as future enhancement
- Share admin password securely among trusted co-GMs
- Implement audit logging to track actions by session

Future Enhancement:
- Add admin_users table
- Support multiple admin accounts with usernames
- Role-based permissions (read-only vs full admin)

RISK-B2: Database Corruption
Severity: HIGH
Probability: LOW
Impact: Complete data loss, application unusable

Mitigation:
- Implement automated daily backups
- Store backups in separate location
- Test restore procedure quarterly
- Use SQLite's write-ahead logging (WAL) mode
- Implement database health checks
- Monitor disk space

Backup Script:
```bash
#!/bin/bash
# backup_database.sh

BACKUP_DIR="/backups/galacticstocks"
DB_PATH="/app/backend/galactic_market.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/galactic_market_$TIMESTAMP.db"

# Create backup
cp "$DB_PATH" "$BACKUP_FILE"

# Verify backup
sqlite3 "$BACKUP_FILE" "PRAGMA integrity_check;"

# Keep only last 30 days
find "$BACKUP_DIR" -name "galactic_market_*.db" -mtime +30 -delete

echo "Backup completed: $BACKUP_FILE"
```


11.5 RISK MATRIX SUMMARY
-------------------------

| Risk ID | Risk                          | Severity | Probability | Mitigation Status |
|---------|-------------------------------|----------|-------------|-------------------|
| T1      | Database Migration Failure    | HIGH     | LOW         | Comprehensive     |
| T2      | Password Security Vuln        | HIGH     | MEDIUM      | Comprehensive     |
| T3      | CSV Upload Vulnerabilities    | MEDIUM   | MEDIUM      | Comprehensive     |
| T4      | WebSocket Instability         | MEDIUM   | MEDIUM      | Adequate          |
| T5      | Performance Degradation       | MEDIUM   | LOW         | Adequate          |
| O1      | GM Loses Admin Password       | MEDIUM   | MEDIUM      | Adequate          |
| O2      | Accidental Ticker Deletion    | MEDIUM   | LOW         | Comprehensive     |
| O3      | Incorrect Price Override      | LOW      | MEDIUM      | Adequate          |
| O4      | Concurrent Timestep Gen       | MEDIUM   | LOW         | Comprehensive     |
| U1      | Confusing Admin Interface     | MEDIUM   | MEDIUM      | Adequate          |
| U2      | Players Access Admin Panel    | LOW      | HIGH        | Comprehensive     |
| U3      | Tooltip Obstructs UI          | LOW      | MEDIUM      | Adequate          |
| B1      | Single Admin Account          | LOW      | N/A         | Documented        |
| B2      | Database Corruption           | HIGH     | LOW         | Comprehensive     |


================================================================================
END OF TECHNICAL SPECIFICATION
================================================================================

This specification document provides complete implementation-ready details for
the GalacticStocks native admin panel and sell feature enhancement. All
database schemas, API endpoints, component architectures, and security measures
are defined with sufficient detail for developers to implement without
requiring additional clarification.

For questions or clarifications during implementation, refer to:
- Database schema definitions (Section 4)
- API endpoint specifications (Section 5)
- Component architecture (Section 6)
- Security requirements (Section 7)
- Testing requirements (Section 9)

Version History:
- v1.0 (2026-01-03): Initial high-level plan
- v2.0 (2026-01-03): Complete technical specification

Next Steps:
1. Review specification with development team
2. Begin Phase 1: Database Migration (Week 1, Day 1)
3. Follow implementation timeline (Section 10)
4. Report progress at each milestone
5. Conduct testing according to Section 9
6. Deploy following Section 8 migration strategy
